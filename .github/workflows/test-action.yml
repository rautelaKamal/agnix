name: Test Action

on:
  push:
    branches: [main, feature/*]
    paths:
      - 'action.yml'
      - 'scripts/**'
      - '.github/workflows/test-action.yml'
  pull_request:
    paths:
      - 'action.yml'
      - 'scripts/**'
      - '.github/workflows/test-action.yml'
  workflow_dispatch:

jobs:
  test-action:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Test action (default inputs)
        id: test-default
        uses: ./
        continue-on-error: true

      - name: Verify outputs set and valid
        shell: bash
        env:
          RESULT: ${{ steps.test-default.outputs.result }}
          ERRORS: ${{ steps.test-default.outputs.errors }}
          WARNINGS: ${{ steps.test-default.outputs.warnings }}
        run: |
          echo "Result: ${RESULT}"
          echo "Errors: ${ERRORS}"
          echo "Warnings: ${WARNINGS}"

          # Verify result output is set and valid
          if [ -z "${RESULT}" ]; then
            echo "Error: result output not set"
            exit 1
          fi

          if [ "${RESULT}" != "success" ] && [ "${RESULT}" != "failure" ]; then
            echo "Error: result must be 'success' or 'failure', got '${RESULT}'"
            exit 1
          fi

          # Verify errors and warnings are numeric
          if ! [[ "${ERRORS}" =~ ^[0-9]+$ ]]; then
            echo "Error: errors output must be numeric, got '${ERRORS}'"
            exit 1
          fi

          if ! [[ "${WARNINGS}" =~ ^[0-9]+$ ]]; then
            echo "Error: warnings output must be numeric, got '${WARNINGS}'"
            exit 1
          fi

      - name: Test action (strict mode)
        id: test-strict
        uses: ./
        with:
          strict: 'true'
        continue-on-error: true

      - name: Test action (target claude-code)
        id: test-target
        uses: ./
        with:
          target: 'claude-code'
        continue-on-error: true

      - name: Test action (target cursor)
        id: test-cursor
        uses: ./
        with:
          target: 'cursor'
        continue-on-error: true

      - name: Test action (JSON output)
        id: test-json
        uses: ./
        with:
          format: 'json'
        continue-on-error: true

      - name: Verify JSON output values
        shell: bash
        env:
          RESULT: ${{ steps.test-json.outputs.result }}
          ERRORS: ${{ steps.test-json.outputs.errors }}
        run: |
          # Verify outputs are populated from JSON parsing
          if [ -z "${RESULT}" ]; then
            echo "Error: JSON format did not produce result output"
            exit 1
          fi
          echo "JSON format test passed: result=${RESULT}, errors=${ERRORS}"

      - name: Test action (SARIF output)
        id: test-sarif
        uses: ./
        with:
          format: 'sarif'
        continue-on-error: true

      - name: Verify SARIF file created and valid
        shell: bash
        env:
          SARIF_FILE: ${{ steps.test-sarif.outputs.sarif_file }}
        run: |
          if [ -z "${SARIF_FILE}" ]; then
            echo "Error: sarif_file output not set"
            exit 1
          fi

          if [ ! -f "${SARIF_FILE}" ]; then
            echo "Error: SARIF file not found: ${SARIF_FILE}"
            exit 1
          fi

          # Verify SARIF is valid JSON with expected structure
          if ! python3 -c "import json; d=json.load(open('${SARIF_FILE}')); assert 'runs' in d and 'version' in d" 2>/dev/null; then
            echo "Error: SARIF file is not valid or missing required fields"
            exit 1
          fi

          echo "SARIF file validated: ${SARIF_FILE}"

      - name: Test action (verbose)
        id: test-verbose
        uses: ./
        with:
          verbose: 'true'
        continue-on-error: true

      - name: Test action (custom path)
        id: test-path
        uses: ./
        with:
          path: './crates'
        continue-on-error: true

  test-sarif-upload:
    name: Test SARIF Upload
    runs-on: ubuntu-latest
    permissions:
      security-events: write

    steps:
      - uses: actions/checkout@v4

      - name: Run agnix with SARIF
        id: agnix
        uses: ./
        with:
          format: 'sarif'
        continue-on-error: true

      - name: Upload SARIF to GitHub
        if: steps.agnix.outputs.sarif_file != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ steps.agnix.outputs.sarif_file }}
        continue-on-error: true
