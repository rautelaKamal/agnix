# Implementation Plan: #13 - Add SARIF output format for CI integration

## Overview

Add `--format sarif` CLI option that outputs validation results as SARIF 2.1.0 JSON for GitHub Code Scanning integration.

## Architecture Decision

Keep SARIF logic in CLI crate (not core) since it's output formatting, not validation logic. Use existing serde patterns for JSON serialization.

---

## Step 1: Add serde_json dependency to agnix-cli

**File:** `crates/agnix-cli/Cargo.toml`

Add workspace dependencies for serde and serde_json (already available in workspace).

---

## Step 2: Create sarif.rs module with SARIF 2.1.0 structs

**File:** `crates/agnix-cli/src/sarif.rs` (NEW)

Define SARIF data structures:
- `SarifLog` - Root with version "2.1.0", schema URL, runs array
- `Run` - Contains tool and results
- `Tool` / `Driver` - agnix tool info with all 80 rules
- `ReportingDescriptor` - Rule definitions (id, description, help URI)
- `SarifResult` - Individual finding with ruleId, level, message, locations
- `Location` / `PhysicalLocation` / `Region` - File location info

Key conversion logic:
- `fn diagnostics_to_sarif(diagnostics: &[Diagnostic], base_path: &Path) -> SarifLog`
- Map DiagnosticLevel: Error→"error", Warning→"warning", Info→"note"
- Convert absolute paths to relative with forward slashes

---

## Step 3: Add --format CLI argument and dispatch logic

**File:** `crates/agnix-cli/src/main.rs`

Changes:
- Add `mod sarif;` declaration
- Add `OutputFormat` enum (Text, Sarif) with clap ValueEnum derive
- Add `--format` argument with default "text"
- Dispatch to SARIF output when format is sarif
- Output JSON to stdout, maintain exit code semantics (0=success, 1=errors)

---

## Step 4: Add tests for SARIF output

**File:** `crates/agnix-cli/src/sarif.rs`

Unit tests:
- Correct SARIF version (2.1.0)
- Schema URL present
- Level mapping works correctly
- File paths are relative with forward slashes
- Rules array contains expected rule IDs
- Empty diagnostics produces valid SARIF
- Multiple diagnostics produce correct results

---

## Verification Criteria

1. `cargo check` passes
2. `cargo test` passes
3. `cargo run --bin agnix -- . --format sarif` produces valid JSON
4. Output validates against SARIF 2.1.0 schema

---

## Files Summary

| File | Action |
|------|--------|
| `crates/agnix-cli/Cargo.toml` | Modify - add dependencies |
| `crates/agnix-cli/src/sarif.rs` | Create - SARIF structs and conversion |
| `crates/agnix-cli/src/main.rs` | Modify - add --format arg |

## Complexity: Medium | Confidence: High
